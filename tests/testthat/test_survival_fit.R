context("fitting survival models")

data <- data.frame(time = rexp(100, rate = 0.01),
                   status = rep(1, 100),
                   group = rep(1, 100))

test_that("input errors are caught", {
  expect_error(
  f_fit_survival_models(
    data,
    dist,
    time_col_name = "time2",
    censor_col_name = "status",
    treatment_col_name = "group",
    fit_indiv_groups = F
  ),
  "time_col_name"
)
expect_error(
  f_fit_survival_models(
    data,
    dist,
    time_col_name = "time",
    censor_col_name = "status2",
    treatment_col_name = "group",
    fit_indiv_groups = F
  ),
  "censor_col_name"
)
expect_error(
  f_fit_survival_models(
    data,
    dist,
    time_col_name = "time",
    censor_col_name = "status",
    treatment_col_name = "group2",
    fit_indiv_groups = F
  ),
  "treatment_col_name"
)

expect_error(
  f_fit_survival_models(
    as.list(data),
    dist,
    time_col_name = "time",
    censor_col_name = "status",
    treatment_col_name = "group2",
    fit_indiv_groups = F
  ),
  "is.data.frame"
)

expect_error(
  f_fit_survival_models(
    data[0, ],
    dist,
    time_col_name = "time",
    censor_col_name = "status",
    treatment_col_name = "group2",
    fit_indiv_groups = F
  ),
  "nrow(survdata)", fixed = TRUE
)



})

test_that("getting survival inputs works",
          {
            ref_1 <- heemod:::read_file(system.file(
              "tabular/test",
              "survival_spec_1.csv",
              package = "heemod"
            ))
            mixed_order <- heemod:::read_file(system.file(
              "tabular/test",
              "survival_spec_2.csv",
              package = "heemod"
            ))
            ref_3 <- ref_1
            ref_3$data <- gsub("_pfs", "_pfs2", ref_1$data)
            input <- 
              list(
                surv_data_dir = "survival_data",
                fit_files = c("OS.surv.fit", "PFS.surv.fit"),
                fit_names = c("OS.fit", "PFS.fit"),
                surv_data_files = c("OS.data.csv",
                                    "PFS.data.csv"),
                fit_metric = "AIC",
                time_col_name = "time",
                censor_col_name = "status",
                treatment_col_name = "treatment",
                dists = c("exp", "weibull", "lnorm", "gamma", 
                          "gompertz", "gengamma")
              )
            
            expect_identical(get_survival_input(ref_1), input)
            expect_identical(get_survival_input(mixed_order), input)
            expect_identical(get_survival_input(ref_3), input)
            
            ref_error_1 <- read_file(system.file(
              "tabular/test",
              "survival_spec_error_1.csv",
              package = "heemod"
            ))
            
            
            expect_error(get_survival_input(ref_error_1),
                         "suffixes do not match")
            
            ref_error_2 <- read_file(system.file(
              "tabular/test",
              "survival_spec_error_2.csv",
              package = "heemod"
            ))
            expect_error(get_survival_input(ref_error_2),
                         "same number of elements")

            ref_error_3 <- ref_3
            ref_error_3$data <- gsub("_pfs", "_os", ref_3$data)
            expect_error(get_survival_input(ref_error_3),
                         "must have each suffix OS and PFS once"
                         )
          }
)

test_that("we handle fitting errors",
          {
            ## some data that causes an error when
            ##  fitting with generalized gamma
            this_dat <- 
              tibble::tribble(
              ~time, ~event, ~trt,
              251,0,"A",
              250,0,"A",
              91,1,"A",
              173,1,"A",
              467,0,"A",
              382,0,"A",
              247,1,"A",
              8,1,"A",
              291,1,"A",
              49,1,"A",
              1,1,"A",
              2,1,"A",
              259,0,"A",
              288,0,"A",
              212,0,"A",
              45,1,"A",
              9,1,"A",
              257,0,"A",
              63,1,"A",
              69,1,"A",
              338,0,"A",
              292,0,"A",
              248,1,"A",
              1,1,"A",
              1,1,"A",
              73,1,"A",
              223,0,"A",
              1,1,"A",
              2,1,"A",
              378,0,"A",
              464,0,"A",
              295,0,"A",
              40,1,"A",
              2,1,"A",
              44,1,"A"
            )
            suppressMessages(
            fit <- f_fit_survival_models(this_dat, 
                                         dist = c("exp", "weibull", "gengamma"),
                                         time_col_name = "time", 
                                         censor_col_name = "event", 
                                         treatment_col_name = "trt",
                                         fit_indiv_groups = FALSE)
            )
            expect_equal(sapply(fit, class),
                         c("flexsurvreg", "flexsurvreg", "try-error")
                         )
            }
          )


test_that("subsetting fit objects works",
          {
          fit_matrix <- 
            partitioned_survival_from_tabular(base_dir = system.file("tabular\\surv", 
                                                          package = "heemod"), 
                                              ref_file = "example_oncSpecs.csv", 
                                              df_env = new.env(), 
                                              state_names = c("ProgressionFree", "Progressive", 
                                              "Terminal", "Death"), 
                                             save_fits = FALSE)
          ## not concerned about the particular test, just
          ##   that it finishes as opposed to giving an error
          expect_equal(names(combine_part_surv(fit_matrix, 
                              A = list(pfs = "exp", os = "weibull"),
                              B = list(pfs = "exp", os = "lnorm"))),
                         c("A", "B")
                         )
          
          
          expect_error(combine_part_surv(fit_matrix, 
                                         A = list(pfs = "exp", os = "weibull"),
                                         Z = list(pfs = "exp", os = "lnorm")),
                       "column names of fit_matrix")
          expect_error(combine_part_surv(fit_matrix, 
                                         A = list(pfs = "exp", os = "weibul"),
                                         B = list(pfs = "exp", os = "lnorm")), 
                       "row names of fit_matrix")
          expect_error(combine_part_surv(fit_matrix, 
                                         A = list(PFS = "exp", os = "weibull"),
                                         B = list(pfs = "exp", os = "lnorm")), 
                       "only names os and pfs")
          })




#set seed
set.seed(5001)

#define distributions to test
dist_fit = c("exp", "weibull", "lnorm", "gamma", "gompertz", "llogis")
params <- list(
  exp = c(rate = 1 / 50),
  weibull = c(shape = 1, scale = 50),
  lnorm = c(meanlog = log(50), sdlog = 0.75),
  gamma = c(shape = 1, rate = 1 / 50),
  gompertz = c(shape = 1, rate = 1 / 50),
  llogis = c(shape = 3, scale = 50)
)

for (i in 1:length(dist_fit))
{
  dist = dist_fit[i]
  
  #testthat instance per distribution
  test_that(paste(
    "Survival fit matches well with Markov-based simulations for ",
    dist,
    sep = ""
  ),
  {
    #define number of patients
    for (n_patients in c(100, 10000)) {
      args_list <- as.list(c(n = n_patients, params[[dist]]))
      event.time <- do.call(paste0("r", dist),
                            args_list)
      
      #set-up censor time
      censor.time = rep(10000, n_patients)
      
      #get censor status
      obs.time = pmin(event.time, censor.time)
      status = as.numeric(obs.time == event.time)
      
      #set-up simulated data as belonging to one patient group
      group = rep(1, n_patients)
      data = data.frame(time = event.time,
                        status = status,
                        group = group)
      
      #get max.time
      max.time = floor(max(data$time))
      
      #fit survival distribution
      fit = f_fit_survival_models(
        data,
        dist,
        time_col_name = "time",
        censor_col_name = "status",
        treatment_col_name = "group",
        fit_indiv_groups = F
      )[[1]]
      
      # generate KM estimates
      mf <- stats::model.frame(fit)
      Xraw <- mf[, attr(mf, "covnames.orig"), drop = FALSE]
      dat <- fit$data
      isfac <- sapply(Xraw, is.factor)
      mm <-  as.data.frame(stats::model.matrix(fit))
      form <-
        "survival::Surv(dat$Y[,\"start\"],dat$Y[,\"stop\"],dat$Y[,\"status\"]) ~ "
      
      form <- paste(form,
                    if (fit$ncovs > 0 && all(isfac))
                      paste("mm[,", 1:fit$ncoveffs, "]", collapse = " + ")
                    else
                      1)
      form <- stats::as.formula(form)
      km <-
        summary(survival::survfit(form, data = mm), times = c(0:max.time))
      
      # generate fit prediction estimates
      fit_pred = summary(fit, t = c(0:max.time))[[1]]$est
      
      ## correctness of fitting of survival function
      ## check that true value is within 95% confidence interval
      ## note there's actually a potential problem with multiple
      ##   testing here, which we might need to deal with at some point
      for (this_param in names(params[[dist]])) {
        lower <- fit$res[this_param, 2]
        upper <- fit$res[this_param, 3]
        true_val <- params[[dist]][this_param]
        expect_gt(true_val - lower, 0)
        expect_gt(upper - true_val, 0)
      }  # end loop around different parameters
      
    }  # end loop around n_patients
  })
}  # end loop around distributions


