library(shinyjs)

function(request) {
  fluidPage(
    lang = "en-US",
    useShinyjs(),
    inlineCSS(list(
      ".row-eq-height"  = c(
        "display: -webkit-box",
        "display: -webkit-flex",
        "display: -ms-flexbox",
        "display: flex"
      ),
      ".rotateIcon" = c(
        "-webkit-transition: 0.5s ease-in-out",
        "-moz-transition: 0.5s ease-in-out",
        "-o-transition: 0.5s ease-in-out",
        "transition: 0.5s ease-in-out"
      ),
      ".rotateIcon:hover" = c(
        "-webkit-transform: rotate(45deg)",
        "-moz-transform: rotate(45deg)",
        "-o-transform: rotate(45deg)",
        "-ms-transform: rotate(45deg)",
        "transform: rotate(45deg)"
      )
    )),
    navbarPage(
      "heemod",
      id = "main",
      
      tabPanel(
        "States",
            fluidRow(
              column(
                6, 
                wellPanel(
                  numericInput(
                    "nbStates",
                    label = "Number of States",
                    value = "",
                    min = 1
                  )
                )
              ),
              column(
                6, 
                wellPanel(
                  numericInput(
                    "nbStrategies",
                    label = "Number of Strategies",
                    value="",
                    min = 1
                  )
                )
              )
            ),
            fluidRow(
              column(
                6, 
                uiOutput("nameStates")
              ),
              column(
                6, 
                uiOutput("nameStrategies")
              )
            ),
            conditionalPanel(
              condition = "input.checkShowHelp == 1",
              fluidRow(
                column(
                  6,
                  wellPanel(
                    style = "background-color: #ffffff;",
                    em("Number of distinct states in the model, and their names.")
                  )
                ),
                column(
                  6,
                  wellPanel(
                    style = "background-color: #ffffff;",
                    em("Number of strategies to compare.")
                  )
                )
              )
            )
      ),
      
      #       tabPanel(
      #         "Parameters", 
      #         sidebarLayout(
      #           sidebarPanel(
      #             h3("Mortality rate"),
      #             checkboxInput(
      #               "use_morta",
      #               "Use in model? (as mortality_rate)",
      #               width = "100%"
      #             ),
      #             numericInput(
      #               "startAge",
      #               "Age at beginning",
      #               0,
      #               width = "100%"
      #             ),
      #             numericInput(
      #               "cycleLength",
      #               "Duration of a cycle (years)",
      #               1,
      #               width = "100%"
      #             ),
      #             radioButtons(
      #               "gender",
      #               "Sex",
      #               choices = c(Female = "FMLE", Male = "MLE")
      #             ),
      #             uiOutput("searchRegion"),
      #             uiOutput("searchCountry"),
      #             conditionalPanel(
      #               condition = "input.checkShowHelp == 1",
      #               wellPanel(
      #                 style = "background-color: #ffffff;",
      #                 em("Input age-specific mortality rate from WHO databases."),
      #                 em("The rate can then be called in transitions matrixes by its name ("),
      #                 strong("mortality_rate"),
      #                 em(").")
      #               )
      #             )
      #           ),
      #           mainPanel(
      #             h3("Custom parameters"),
      #             uiOutput("globalParameters"),
      #             conditionalPanel(
      #               condition = "input.checkShowHelp == 1",
      #               fluidRow(
      #                 column(
      #                   4,
      #                   wellPanel(
      #                     style = "background-color: #ffffff;",
      #                     em("Optional parameters to be called in transition matrix or state values. 
      #                The variable "),
      #                     strong("markov_cycle"),
      #                     em(" is defined inside the model and takes values 0, 1, 2... n at each cycle.
      #                It can thus be used to define time-varying properties (such as age = 50 + markov_cycle).")
      #                   )
      #                 )
      #               )
      #             )
      #           )
      #         )
      #       ), 
      
      tabPanel(
        "Transition Matrix",    
        fluidRow(
          column(
            12,
            uiOutput("transMatrix1"),
            conditionalPanel(
              condition = "input.nbStrategies > 1",
              column(
                3,
                offset=3,
                actionButton(
                  "copyValuesParametersTM",
                  "Copy values for other strategies"
                )
              )
            )
          )
        ),
        fluidRow(
          column(
            12,
            uiOutput("transMatrix2")
          )
        ),
        conditionalPanel(
          condition = "input.checkShowHelp == 1",
          fluidRow(
            column(
              4,
              wellPanel(
                style = "background-color: #ffffff;",
                p(em("Matrix of transition probabilities between states.
               References can be made to parameters computed in the previous tab.
               The sum of probabilities per row must equal 1.")),
                  p(em("The alias "),
                strong("C"),
                em(" (meaning probability complement) means 1 minus the row sum of other probabilities.")),
                   p(em("The variable "),
                strong("markov_cycle"),
                em(" is defined inside the model and takes values 0, 1, 2... n at each cycle.
               It can thus be used to define time-varying properties (such as p = 1 / (markov_cycle + 1))."))
              )
            )
          )
        )
      ),
      tabPanel(
        "States Values",
        sidebarLayout(
          sidebarPanel(
            numericInput(
              "nbStateVariables",
              label = "Number of State Variables",
              value = 2,
              min = 2
            ),
            uiOutput("nameStateVariables"),
            wellPanel(
              style = "background-color: #ffffff;",
              em("Number of values attached to states (such as cost, utility...), and their names.
               Names should not contain spaces, start with '.', or special characters.")
            )
          ),
          mainPanel(
            fluidRow(
              column(
                12,
                uiOutput("stateParameters1"),
                conditionalPanel(
                  condition = "input.nbStrategies > 1",
                  column(
                    3,
                    offset=3,
                    actionButton(
                      "copyValuesParametersSP",
                      "Copy values for other strategies"
                    )
                  )
                )
              )
            ),
            fluidRow(
              column(
                12,
                uiOutput("stateParameters2")
              )
            ),
            conditionalPanel(
              condition = "input.checkShowHelp == 1",
              fluidRow(
                column(
                  4,
                  wellPanel(
                    style = "background-color: #ffffff;",
                    em("Values associated with each state for each strategy.")
                  )
                )
              )
            ),
            conditionalPanel(
              condition = "input.nbStates > 0 & input.nbStateVariables > 1",
              fluidRow(
                column(
                  6,
                  uiOutput(
                    "costVariable"
                  )
                ),
                column(
                  6,
                  uiOutput(
                    "effectVariable"
                  )
                )
              )
            ),
            conditionalPanel(
              condition = "input.checkShowHelp == 1 & input.nbStates > 0 & input.nbStateVariables > 1",
              fluidRow(
                column(
                  6,
                  wellPanel(
                    style = "background-color: #ffffff;",
                    em("State variable name representing "),
                    strong("cost"),
                    em(" in the model (or mathematical expression using variable names, such as (var1+var2)/2).")
                  )
                ),
                column(
                  6,
                  wellPanel(
                    style = "background-color: #ffffff;",
                    em("State variable name representing "),
                    strong("effect"),
                    em(" in the model (or mathematical expression using variable names, such as (var1+var2)/2).")
                  )
                )
              )
            )
          )
        )
      ),
      tabPanel(
        "Results",
        sidebarLayout(
          sidebarPanel(
            h3("Model parameters"),
            selectInput(
              "countMethod",
              "Counting method",
              c("beginning", "end", "cycle-tree",
                "half-cycle", "life-table", "spread-half-cycle"),
              selected = "life-table"
            ),
            numericInput("cycles", value = 10, label = "Number of cycle"),
            conditionalPanel(
              condition = "input.checkShowHelp == 1",
              wellPanel(
                style = "background-color: #ffffff;",
                em("Counting method for state membership."),
                strong("beginning"),
                em(" assume transitions occur at the beginning of each cycle, "),
                strong("end"),
                em(" at the end of each cycle, "),
                strong("half-cycle"),
                em(" tries to corrects counts (but actually fails...) by adding 
                 half of the initial count and "),
                strong("life-table"),
                em(" assume transitions occur at the middle of each cycle. "),
                strong("life-table"),
                em(" is probably the less incorrect method in most situations.")
              )
            ),
            uiOutput("outInit"),
            conditionalPanel(
              condition = "input.checkShowHelp == 1 & input.nbStates > 0",
              wellPanel(
                style = "background-color: #ffffff;",
                em("Initial counts per state applied to all models. 
                 Should be a positive number.")
              )
            )
          ),
          mainPanel(
            uiOutput("outModel"),
            DT::dataTableOutput("tableResults"),
            uiOutput("titleICER"),
            DT::dataTableOutput("tableICER"),
            uiOutput("outCounts"),
            plotOutput("plotCounts")
          )
        )
      ),
      footer = wellPanel(
        fluidRow(
          column(
            3,
            em("heemod by KZ & AFP"),
            br(),
            tags$a(
              href = "https://pierucci.github.io/heemod/",
              "More info",
              target="_blank"
            )
          ),
          column(
            3,
            checkboxInput(
              "checkShowHelp",
              "Show help",
              value = TRUE
            )
          ),
          column(
            3, 
            offset = 3,
            bookmarkButton()
          )
        )
      )
    )
  )
  
}
